<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streetszapa - Catálogo de Productos</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root {
            --background-color: #121212;
            --card-background: #1E1E1E;
            --text-color: #FFFFFF;
            --text-secondary-color: #B3B3B3;
            --accent-color: #FFD700;
            --shadow: 0 4px 15px rgba(0,0,0,0.2);
            --border-color: #333333;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); margin: 0; padding: 20px; color: var(--text-color); }
        header { padding: 20px 0; text-align: center; margin-bottom: 20px; }
        #logo-streetszapa { max-width: 120px; }
        .catalogo-general-container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }

        /* Estilos para el buscador */
        .search-container {
            margin-bottom: 30px;
            text-align: center;
        }
        #search-input {
            width: 100%;
            max-width: 400px;
            padding: 12px 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-background);
            color: var(--text-color);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }
        #search-input::placeholder {
            color: var(--text-secondary-color);
        }
        #search-input:focus {
            border-color: var(--accent-color);
        }

        .talle-section { margin-bottom: 40px; }
        .talle-section-header { font-size: 2.2rem; font-weight: 700; color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 25px; }
        .productos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        .zapatilla-card { 
            background-color: var(--card-background); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            overflow: hidden; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .zapatilla-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .zapatilla-card img { width: 100%; height: 250px; object-fit: cover; }
        .card-content { padding: 15px; display: flex; flex-direction: column; flex-grow: 1; }
        .card-content h2 { font-size: 1.3rem; font-weight: 600; flex-grow: 1; margin-top: 5px; margin-bottom: 10px; } /* Ajuste de márgenes */
        .card-content .marca { font-size: 0.95rem; color: var(--text-secondary-color); margin-bottom: 5px; }
        /* .card-content .precio { font-size: 1.4rem; font-weight: 700; color: var(--accent-color); margin: 10px 0 15px 0; } */ /* ELIMINADO: Precio */
        .stock-info { font-size: 0.9em; color: var(--text-secondary-color); margin-top: 5px; }
        .talle-stock-item { 
            display: inline-block; 
            background-color: #333; 
            color: white; 
            padding: 5px 10px; 
            border-radius: 5px; 
            margin: 3px; 
            font-size: 0.85em; /* Un poco más pequeño para optimizar espacio */
            white-space: nowrap; /* Evita que el talle/stock se parta */
        }
        .talle-stock-item.no-stock { background-color: #666; opacity: 0.7; }

        footer { background: #1E1E1E; text-align: center; padding: 25px; margin-top: 40px; border-top: 1px solid var(--border-color); }
        .social-icons a { margin: 0 15px; } 
        .social-icons img { width: 30px; transition: transform 0.2s; }
        .social-icons a:hover img { transform: scale(1.1); }
    </style>
</head>
<body>
    <header>
        <img id="logo-streetszapa" src="https://i.imgur.com/G5Zua4s.png" alt="Logo de Streetszapa">
    </header>
    <div class="catalogo-general-container">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Buscar por talle (ej: 41, us 9.5) o marca (ej: Nike)">
        </div>

        <main id="catalogo-container">
            <p>Cargando catálogo...</p>
        </main>
    </div>
    <footer>
        <p><strong>Dirección:</strong> Lizandro de la Torre 938, San Salvador de Jujuy</p>
        <p><strong>Teléfono:</strong> 388 468-9497</p>
        <div class="social-icons">
            <a href="https://www.facebook.com/telasjujuy" target="_blank" rel="noopener noreferrer"><img src="https://i.imgur.com/8p5z5YF.png" alt="Facebook"></a>
            <a href="https://www.instagram.com/streetszapas/" target="_blank" rel="noopener noreferrer"><img src="https://i.imgur.com/vHAPDoE.png" alt="Instagram"></a>
            <a href="#" target="_blank" rel="noopener noreferrer"><img src="https://i.imgur.com/11sFC1g.png" alt="TikTok"></a>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        (function() {
            // Reemplaza con tus credenciales de Supabase
            var SUPABASE_URL = 'https://ilauxmesrvylqtluidpv.supabase.co';
            var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFhZXMuc3J2eWxxdGx1aWRwdiIsInJlZiI6ImlsYXV4bWVzcnZ5bHF0bHVpZHB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MjI2NzMsImV4cCI6MjA2NjE5ODY3M30.tDYyt5FaZu4daZ6f7_dZnOlFRMEtlE7gs_pcQYRAP0Y';
            var supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            var catalogoContainer = document.getElementById('catalogo-container');
            var searchInput = document.getElementById('search-input'); 

            let allProducts = []; // Almacena todos los productos para filtrar en el cliente

            // Función principal para cargar y mostrar el catálogo
            async function iniciarCatalogo() {
                try {
                    // Consulta los modelos, incluyendo la marca y el inventario (sin el campo de precio)
                    const { data: modelos, error: modelosError } = await supabaseClient
                        .from('modelos')
                        .select(`
                            id,
                            nombre,
                            foto_url,
                            marcas ( nombre ),
                            inventario ( talle, cantidad )
                        `);

                    if (modelosError) throw modelosError;

                    // Almacenar todos los productos cargados para poder filtrarlos después
                    allProducts = modelos;
                    
                    renderizarCatalogo(allProducts); // Mostrar todos los productos inicialmente

                } catch (e) {
                    catalogoContainer.innerHTML = '<h2>Ha ocurrido un error al cargar el catálogo:</h2><p style="color:red;">' + e.message + '</p>';
                    console.error(e);
                }
            }

            // Función para renderizar el catálogo basada en una lista de productos
            function renderizarCatalogo(productosARenderizar) {
                if (!productosARenderizar || productosARenderizar.length === 0) {
                    catalogoContainer.innerHTML = '<p>No hay productos disponibles con el criterio de búsqueda actual.</p>';
                    return;
                }

                catalogoContainer.innerHTML = ''; // Limpiar el contenido actual

                // Agrupar los productos por marca para una mejor visualización
                const productosPorMarca = {};
                productosARenderizar.forEach(modelo => {
                    const marcaNombre = modelo.marcas ? modelo.marcas.nombre : 'Sin Marca';
                    if (!productosPorMarca[marcaNombre]) {
                        productosPorMarca[marcaNombre] = [];
                    }
                    productosPorMarca[marcaNombre].push(modelo);
                });

                // Ordenar las marcas alfabéticamente
                const marcasOrdenadas = Object.keys(productosPorMarca).sort();

                marcasOrdenadas.forEach(marca => {
                    const seccionMarca = document.createElement('section');
                    seccionMarca.className = 'talle-section';
                    seccionMarca.innerHTML = `<h2 class="talle-section-header">${marca}</h2><div class="productos-grid"></div>`;
                    const productosGrid = seccionMarca.querySelector('.productos-grid');

                    productosPorMarca[marca].forEach(zapatilla => {
                        const imageUrl = SUPABASE_URL + '/storage/v1/object/public/fotos-zapatillas/' + zapatilla.foto_url;
                        
                        // Construir la información de talles y stock
                        let tallesStockHTML = '';
                        if (zapatilla.inventario && zapatilla.inventario.length > 0) {
                            // Ordenar talles numéricamente para una visualización coherente
                            const tallesOrdenados = zapatilla.inventario.sort((a, b) => {
                                // Convierte "us 8" a 8, "41" a 41 para ordenar correctamente
                                const talleA = parseFloat(String(a.talle).toLowerCase().replace('us ', ''));
                                const talleB = parseFloat(String(b.talle).toLowerCase().replace('us ', ''));
                                return talleA - talleB;
                            });
                            
                            tallesOrdenados.forEach(item => {
                                const tieneStock = item.cantidad > 0;
                                // Formatear el talle para mostrar
                                const talleDisplay = String(item.talle).startsWith('us ') ? item.talle.toUpperCase() : item.talle;
                                tallesStockHTML += `<span class="talle-stock-item ${!tieneStock ? 'no-stock' : ''}">${talleDisplay} (${item.cantidad})</span>`;
                            });
                        } else {
                            tallesStockHTML = '<span class="talle-stock-item no-stock">Sin stock registrado</span>';
                        }

                        productosGrid.innerHTML += `
                            <div class="zapatilla-card">
                                <img src="${imageUrl}" alt="${zapatilla.nombre}">
                                <div class="card-content">
                                    <p class="marca">${marca}</p>
                                    <h2>${zapatilla.nombre}</h2>
                                    <div class="stock-info">${tallesStockHTML}</div>
                                </div>
                            </div>
                        `;
                    });
                    catalogoContainer.appendChild(seccionMarca);
                });
            }

            // Función para filtrar productos por talle O por marca
            function filtrarCatalogo() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    renderizarCatalogo(allProducts); // Si el buscador está vacío, mostrar todo
                    return;
                }

                const filteredProducts = allProducts.filter(product => {
                    const marcaNombre = product.marcas ? product.marcas.nombre.toLowerCase() : '';
                    
                    // Condición para buscar por marca
                    if (marcaNombre.includes(searchTerm)) {
                        return true;
                    }

                    // Condición para buscar por talle
                    if (product.inventario && product.inventario.length > 0) {
                        return product.inventario.some(item => {
                            const talleString = String(item.talle).toLowerCase();
                            return talleString.includes(searchTerm);
                        });
                    }
                    return false; // No coincide ni por marca ni por talle
                });

                renderizarCatalogo(filteredProducts);
            }

            // Event Listener para el buscador
            searchInput.addEventListener('input', filtrarCatalogo);

            // Iniciar el catálogo cuando el DOM esté completamente cargado
            document.addEventListener('DOMContentLoaded', iniciarCatalogo);

        })(); // Fin de la función autoejecutable
    </script>
</body>
</html>
