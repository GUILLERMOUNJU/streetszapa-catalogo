<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Streetszapa</title>
    <style>
        /* Aquí van tus estilos CSS existentes, más algunos nuevos o modificados */
        body { font-family: 'Poppins', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #121212; color: white; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 1000px; padding: 20px; } /* Aumentado max-width para el modal */
        #login-form, #contenido-protegido { background-color: #1E1E1E; padding: 30px; border-radius: 8px; border: 1px solid #333; }
        #login-form { max-width: 400px; margin: auto; }
        #contenido-protegido { display: none; text-align: left; }
        h1, h2, h3 { text-align: center; color: #FFD700; }
        h3 { margin-top: 30px; border-top: 1px solid #333; padding-top: 30px;}
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select, textarea { /* Añadido textarea para consistencia de estilo */
            width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #444; background-color: #333; color: white; box-sizing: border-box;
        }
        button { padding: 12px; background-color: #FFD700; color: #121212; border: none; border-radius: 4px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: background-color 0.2s ease; }
        button:hover:not(:disabled) { background-color: #e6c200; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        #login-form button { width: 100%; }
        .error-msg { color: #ff4d4d; text-align: center; margin-top: 15px; height: 20px; }

        /* Estilos para la tabla de administración */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .admin-table th, .admin-table td { padding: 12px; border: 1px solid #333; text-align: left; vertical-align: middle; }
        .admin-table th { background-color: #333; font-weight: 600; }
        .admin-table tbody tr:hover { background-color: #2a2a2a; } /* Hover para filas */
        
        .product-info-cell { display: flex; align-items: center; gap: 15px; }
        .product-info-cell img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #444; }
        .product-details { flex-grow: 1; }
        .product-details .name { font-weight: 600; font-size: 1.1em; }
        .product-details .brand { font-size: 0.9em; color: #bbb; }
        /* .product-details .price { font-size: 0.9em; color: #FFD700; }  -- ELIMINADO: PRECIO */

        .talles-stock-column { max-width: 250px; } /* Para controlar el ancho de la columna de talles */
        .stock-control { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; background-color: #292929; padding: 5px 8px; border-radius: 4px; }
        .stock-control:last-child { margin-bottom: 0; }
        .stock-control span { white-space: nowrap; }
        .stock-input { width: 60px; padding: 6px; margin: 0; font-size: 0.9em; }
        .save-stock-btn { font-size: 0.8rem; padding: 6px 10px; background-color: #25D366; color: white; }
        .delete-stock-btn { font-size: 0.8rem; padding: 6px 10px; background-color: #D32F2F; color: white; } /* Botón para eliminar talle/stock */

        .action-buttons { display: flex; flex-direction: column; gap: 8px; margin-top: 5px;}
        .edit-btn { background-color: #007bff; color: white; padding: 8px 12px; }
        .delete-btn { background-color: #D32F2F; color: white; padding: 8px 12px; }

        #add-product-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .form-full-width { grid-column: 1 / -1; }
        #talles-dynamic-section { grid-column: 1 / -1; border-top: 1px solid #444; margin-top: 10px; padding-top: 20px; }
        .talle-adder { display: flex; gap: 15px; align-items: flex-end; }
        #btn-add-talle { height: 42px; padding: 8px 15px; font-size: 0.9rem; }
        #talles-agregados-lista { list-style: none; padding: 0; margin-top: 15px; }
        .talle-agregado-item { background-color: #333; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .remove-talle-btn { background-color: #D32F2F; color: white; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }


        /* Estilos del Modal de Edición */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #1E1E1E;
            margin: auto;
            padding: 30px;
            border: 1px solid #333;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        .close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content h3 { text-align: center; margin-bottom: 20px; color: #FFD700; }
        .modal-content form { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .modal-content .form-group { margin-bottom: 15px; }
        .modal-content .form-group label { margin-bottom: 5px; }
        .modal-content .form-group input[type="text"],
        .modal-content .form-group select,
        .modal-content .form-group input[type="file"] {
            width: calc(100% - 20px); /* Ajuste para padding */
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #333;
            color: white;
            box-sizing: border-box;
        }
        .modal-content .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-content .modal-buttons button {
            width: auto;
            padding: 10px 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div id="login-form">
            <h1>Admin Streetszapa</h1>
            <form id="form">
                <label for="email">Email</label>
                <input type="email" id="email" required>
                <label for="password">Contraseña</label>
                <input type="password" id="password" required>
                <button type="submit">Ingresar</button>
            </form>
            <p id="error-message" class="error-msg"></p>
        </div>

        <div id="contenido-protegido">
            <h2>Panel de Control</h2>

            <div id="add-product-section">
                <h3>Añadir Nuevo Producto</h3>
                <form id="add-product-form">
                    <div>
                        <label for="nombre-add">Nombre del Modelo</label>
                        <input type="text" id="nombre-add" required>
                    </div>
                    <div>
                        <label for="marca-add">Marca</label>
                        <select id="marca-add" required></select>
                    </div>
                    <div>
                        <label for="foto-add">Foto del Producto</label>
                        <input type="file" id="foto-add" accept="image/*" required>
                    </div>
                    <div id="talles-dynamic-section" class="form-full-width">
                        <h4>Añadir Talles y Stock</h4>
                        <div class="talle-adder">
                            <div>
                                <label for="nuevo-talle">Talle</label>
                                <input type="text" id="nuevo-talle" placeholder="Ej: 41, US 9.5">
                            </div>
                            <div>
                                <label for="nuevo-stock">Stock</label>
                                <input type="number" id="nuevo-stock" min="0" value="1">
                            </div>
                            <button type="button" id="btn-add-talle">Añadir Talle</button>
                        </div>
                        <p><strong>Talles a registrar:</strong></p>
                        <ul id="talles-agregados-lista"></ul>
                    </div>
                    <div class="form-full-width">
                        <button type="submit">Guardar Nuevo Producto</button>
                    </div>
                </form>
            </div>

            <h3>Inventario Actual</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Talles y Stock</th>
                        <th>Acciones</th> </tr>
                </thead>
                <tbody id="inventario-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Editar Producto</h3>
            <form id="edit-product-form">
                <input type="hidden" id="edit-product-id"> <input type="hidden" id="edit-current-foto-url"> <div class="form-group">
                    <label for="edit-nombre">Nombre del Modelo</label>
                    <input type="text" id="edit-nombre" required>
                </div>
                <div class="form-group">
                    <label for="edit-marca">Marca</label>
                    <select id="edit-marca" required></select>
                </div>
                <div class="form-group">
                    <label>Imagen Actual:</label>
                    <img id="edit-current-foto" src="" alt="Imagen del producto" style="max-width: 150px; display: block; margin-top: 10px;">
                    <label for="edit-foto" style="margin-top: 15px;">Cambiar Foto (opcional)</label>
                    <input type="file" id="edit-foto" accept="image/*">
                </div>

                <div class="modal-buttons">
                    <button type="button" class="close-button-modal">Cancelar</button>
                    <button type="submit">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ilauxmesrvylqtluidpv.supabase.co'; // Tus credenciales
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsYXV4bWVzcnZ5bHF0bHVpZHB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MjI2NzMsImV4cCI6MjA2NjE5ODY3M30.tDYyt5FaZu4daZ6f7_dZnOlFRMEtlE7gs_pcQYRAP0Y'; // Tus credenciales
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Referencias a elementos del DOM
        const loginForm = document.getElementById('form');
        const loginContainer = document.getElementById('login-form');
        const contenidoProtegido = document.getElementById('contenido-protegido');
        const errorMessage = document.getElementById('error-message');
        const inventarioBody = document.getElementById('inventario-body');

        // Formulario de añadir producto
        const addProductForm = document.getElementById('add-product-form');
        const nombreAddInput = document.getElementById('nombre-add');
        // const precioAddInput = document.getElementById('precio-add'); // CAMBIO: Precio eliminado
        const marcaAddSelect = document.getElementById('marca-add');
        const fotoAddInput = document.getElementById('foto-add');
        const btnAddTalle = document.getElementById('btn-add-talle');
        const nuevoTalleInput = document.getElementById('nuevo-talle');
        const nuevoStockInput = document.getElementById('nuevo-stock');
        const tallesAgregadosLista = document.getElementById('talles-agregados-lista');
        let tallesParaAgregar = []; // Almacena talles/stock para el nuevo producto

        // Modal de edición
        const editProductModal = document.getElementById('editProductModal');
        const closeButtons = document.querySelectorAll('.close-button, .close-button-modal');
        const editProductForm = document.getElementById('edit-product-form');
        const editProductIdInput = document.getElementById('edit-product-id');
        const editCurrentFotoUrlInput = document.getElementById('edit-current-foto-url');
        const editNombreInput = document.getElementById('edit-nombre');
        // const editPrecioInput = document.getElementById('edit-precio'); // CAMBIO: Precio eliminado
        const editMarcaSelect = document.getElementById('edit-marca');
        const editCurrentFoto = document.getElementById('edit-current-foto');
        const editFotoInput = document.getElementById('edit-foto');


        // --- Funciones de Carga Inicial ---

        // Carga las marcas en los selectores (añadir y editar)
        async function cargarMarcasEnSelectores() {
            const selects = [marcaAddSelect, editMarcaSelect];
            
            for (const selector of selects) {
                selector.innerHTML = '<option value="">Cargando marcas...</option>';
            }

            let { data: marcas, error } = await supabaseClient.from('marcas').select('*').order('nombre', { ascending: true });
            
            if (error) {
                for (const selector of selects) {
                    selector.innerHTML = '<option value="">Error al cargar</option>';
                }
                console.error("Error al cargar marcas:", error);
            } else {
                for (const selector of selects) {
                    selector.innerHTML = '<option value="" disabled selected>-- Elige una marca --</option>';
                    marcas.forEach(marca => {
                        selector.innerHTML += `<option value="${marca.id}">${marca.nombre}</option>`;
                    });
                }
            }
        }

        // Muestra el inventario en la tabla principal
        async function mostrarInventario() {
            inventarioBody.innerHTML = '<tr><td colspan="4">Cargando inventario...</td></tr>'; // Columnas: Producto, Talles, Acciones
            
            // Consultar modelos e incluir sus marcas e inventarios
            let { data: modelos, error } = await supabaseClient
                .from('modelos')
                .select(`
                    id,
                    nombre,
                    foto_url,
                    marcas ( nombre ),
                    inventario ( id, talle, cantidad )
                `)
                .order('created_at', { ascending: false });

            if (error) {
                inventarioBody.innerHTML = '<tr><td colspan="4">Error al cargar el inventario.</td></tr>';
                console.error("Error al cargar inventario:", error);
            } else {
                inventarioBody.innerHTML = '';
                if (modelos.length === 0) {
                    inventarioBody.innerHTML = '<tr><td colspan="4">No hay productos en el inventario.</td></tr>';
                    return;
                }

                modelos.forEach(modelo => {
                    const imageUrl = SUPABASE_URL + '/storage/v1/object/public/fotos-zapatillas/' + modelo.foto_url;
                    
                    // Ordenar talles para visualización consistente
                    const tallesOrdenados = modelo.inventario.sort((a, b) => {
                        return parseFloat(String(a.talle).replace('us ', '')) - parseFloat(String(b.talle).replace('us ', ''));
                    });

                    // Construir el HTML para talles y stock
                    let tallesHTML = tallesOrdenados.map(item => `
                        <div class="stock-control">
                            <span>Talle ${item.talle}:</span>
                            <input class="stock-input" type="number" value="${item.cantidad}" min="0">
                            <button class="save-stock-btn" data-inventario-id="${item.id}">Guardar</button>
                            <button class="delete-stock-btn" data-inventario-id="${item.id}">X</button>
                        </div>
                    `).join('');

                    if (tallesOrdenados.length === 0) {
                        tallesHTML = 'Sin talles registrados. <button class="add-talle-to-existing-btn" data-modelo-id="${modelo.id}">Añadir Talle</button>';
                    }

                    const fila = document.createElement('tr');
                    fila.innerHTML = `
                        <td>
                            <div class="product-info-cell">
                                <img src="${imageUrl}" alt="${modelo.nombre}">
                                <div class="product-details">
                                    <div class="name">${modelo.nombre}</div>
                                    <div class="brand">${modelo.marcas ? modelo.marcas.nombre : 'Sin Marca'}</div>
                                    </div>
                            </div>
                        </td>
                        <td>${tallesHTML}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="edit-btn" data-modelo-id="${modelo.id}">Editar Producto</button>
                                <button class="delete-btn" data-modelo-id="${modelo.id}" data-foto-url="${modelo.foto_url}">Eliminar Producto</button>
                            </div>
                        </td>
                    `;
                    inventarioBody.appendChild(fila);
                });
            }
        }

        // Renderiza la lista de talles que se van a añadir a un nuevo producto
        function renderTallesAgregados() {
            tallesAgregadosLista.innerHTML = '';
            if (tallesParaAgregar.length === 0) {
                tallesAgregadosLista.innerHTML = '<li>Aún no has añadido talles para este producto.</li>';
            } else {
                tallesParaAgregar.forEach((item, index) => {
                    tallesAgregadosLista.innerHTML += `
                        <li class="talle-agregado-item">
                            <span>Talle: ${item.talle}</span>
                            <span>Stock: ${item.stock}</span>
                            <button class="remove-talle-btn" data-index="${index}">Eliminar</button>
                        </li>
                    `;
                });
            }
        }

        // --- Manejo de Eventos ---

        // Evento de Login
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            errorMessage.textContent = ''; // Limpiar mensajes de error anteriores

            // Intenta iniciar sesión con email y contraseña
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                errorMessage.textContent = 'Email o contraseña incorrectos.';
                console.error("Error de autenticación:", error);
            } else {
                // Si el login es exitoso, muestra el contenido protegido
                loginContainer.style.display = 'none';
                contenidoProtegido.style.display = 'block';
                // Carga los datos iniciales del panel
                mostrarInventario();
                cargarMarcasEnSelectores();
                renderTallesAgregados(); // Inicializa la lista de talles para agregar
            }
        });

        // Evento para añadir talle al formulario de nuevo producto
        btnAddTalle.addEventListener('click', function() {
            const talle = nuevoTalleInput.value.trim();
            const stock = parseInt(nuevoStockInput.value);

            if (!talle || isNaN(stock) || stock < 0) {
                alert('Ingresa un talle válido y un stock numérico (mayor o igual a 0).');
                return;
            }

            // Opcional: Evitar duplicados de talle en la lista temporal
            if (tallesParaAgregar.some(item => item.talle === talle)) {
                alert(`El talle "${talle}" ya fue agregado.`);
                return;
            }

            tallesParaAgregar.push({ talle: talle, stock: stock });
            renderTallesAgregados();
            nuevoTalleInput.value = '';
            nuevoStockInput.value = '1';
            nuevoTalleInput.focus();
        });

        // Evento para eliminar talle de la lista temporal al añadir nuevo producto
        tallesAgregadosLista.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-talle-btn')) {
                const indexToRemove = parseInt(e.target.dataset.index);
                tallesParaAgregar.splice(indexToRemove, 1);
                renderTallesAgregados();
            }
        });


        // Evento para guardar nuevo producto
        addProductForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const boton = e.target.querySelector('button[type="submit"]');
            boton.textContent = 'Guardando...';
            boton.disabled = true;

            try {
                const nombre = nombreAddInput.value;
                // const precio = parseFloat(precioAddInput.value); // CAMBIO: Precio eliminado
                const marcaId = marcaAddSelect.value;
                const fotoFile = fotoAddInput.files[0];

                if (!nombre || !marcaId) { // CAMBIO: Validacion sin precio
                    throw new Error("Por favor, completa todos los campos (nombre y marca).");
                }
                if (tallesParaAgregar.length === 0) {
                    throw new Error("Debes añadir al menos un talle con stock para el producto.");
                }
                if (!fotoFile) {
                    throw new Error("No se ha seleccionado una foto para el producto.");
                }

                // Subir la imagen a Supabase Storage
                const cleanFileName = fotoFile.name.replace(/\s+/g, '-').replace(/[^\w.-]/g, ''); // Limpiar nombre de archivo
                const fileName = `${Date.now()}-${cleanFileName}`;
                const { error: uploadError } = await supabaseClient.storage.from('fotos-zapatillas').upload(fileName, fotoFile);
                if (uploadError) throw uploadError;

                // Insertar el nuevo modelo en la tabla 'modelos'
                const { data: nuevoModelo, error: modeloError } = await supabaseClient
                    .from('modelos')
                    .insert([{ nombre, foto_url: fileName, marca_id: marcaId }]) // CAMBIO: Precio eliminado
                    .select(); // Asegúrate de que retorna el objeto insertado para obtener el ID
                
                if (modeloError) throw modeloError;
                if (!nuevoModelo || nuevoModelo.length === 0) throw new Error("No se pudo obtener el ID del nuevo modelo.");
                
                const nuevoModeloId = nuevoModelo[0].id;

                // Insertar los talles y stock en la tabla 'inventario'
                const filasParaInventario = tallesParaAgregar.map(item => ({ talle: item.talle, cantidad: item.stock, modelo_id: nuevoModeloId }));
                const { error: inventarioError } = await supabaseClient.from('inventario').insert(filasParaInventario);
                if (inventarioError) throw inventarioError;
                
                alert('¡Producto añadido con éxito!');
                // Resetear el formulario y actualizar la vista
                addProductForm.reset();
                tallesParaAgregar = [];
                renderTallesAgregados();
                mostrarInventario(); // Recargar el inventario para ver el nuevo producto
                
            } catch (error) {
                alert(`Error al guardar el producto: ${error.message}`);
                console.error('Error:', error);
            } finally {
                boton.textContent = 'Guardar Nuevo Producto';
                boton.disabled = false;
            }
        });
        
        // Event Listener para la tabla de inventario (delegación de eventos)
        inventarioBody.addEventListener('click', async function(e) {
            // Manejar botón de Guardar Stock
            if (e.target.classList.contains('save-stock-btn')) {
                const boton = e.target;
                const inventarioId = boton.dataset.inventarioId;
                const nuevoStock = parseInt(boton.parentElement.querySelector('.stock-input').value);
                
                if (isNaN(nuevoStock) || nuevoStock < 0) {
                    alert('El stock debe ser un número positivo.');
                    return;
                }

                boton.textContent = '...';
                boton.disabled = true; // Deshabilitar para evitar múltiples clics
                try {
                    const { error } = await supabaseClient.from('inventario').update({ cantidad: nuevoStock }).eq('id', inventarioId);
                    if (error) throw error;
                    boton.textContent = '✔'; // Muestra un check de éxito
                    setTimeout(() => { boton.textContent = 'Guardar'; boton.disabled = false; }, 1500); // Vuelve al estado normal
                } catch (error) {
                    alert('Error al actualizar stock.');
                    console.error('Error:', error);
                    boton.textContent = 'Guardar';
                    boton.disabled = false;
                }
            }

            // Manejar botón de Eliminar Talle/Stock
            if (e.target.classList.contains('delete-stock-btn')) {
                const boton = e.target;
                const inventarioId = boton.dataset.inventarioId;

                if (confirm('¿Estás seguro de que quieres eliminar este talle y su stock?')) {
                    boton.textContent = '...';
                    boton.disabled = true;
                    try {
                        const { error } = await supabaseClient.from('inventario').delete().eq('id', inventarioId);
                        if (error) throw error;
                        alert('Talle eliminado con éxito.');
                        mostrarInventario(); // Recargar la tabla para reflejar el cambio
                    } catch (error) {
                        alert('Error al eliminar talle.');
                        console.error('Error:', error);
                        boton.textContent = 'X';
                        boton.disabled = false;
                    }
                }
            }

            // Manejar botón de Eliminar Producto
            if (e.target.classList.contains('delete-btn') && e.target.id !== 'realizar-pedido-btn') { // Añadido id !== para evitar conflicto
                const boton = e.target;
                const modeloId = boton.dataset.modeloId;
                const fotoUrl = boton.dataset.fotoUrl; // Nombre de archivo de la foto

                if (confirm('¿Estás seguro de que quieres eliminar este producto (modelo y todo su inventario)?')) {
                    try {
                        boton.textContent = '...';
                        boton.disabled = true;

                        // Primero, eliminar inventario relacionado
                        const { error: deleteInventarioError } = await supabaseClient.from('inventario').delete().eq('modelo_id', modeloId);
                        if (deleteInventarioError) throw deleteInventarioError;

                        // Luego, eliminar el modelo
                        const { error: deleteModeloError } = await supabaseClient.from('modelos').delete().eq('id', modeloId);
                        if (deleteModeloError) throw deleteModeloError;

                        // Finalmente, eliminar la foto del Storage
                        if (fotoUrl) {
                            const { error: deleteFotoError } = await supabaseClient.storage.from('fotos-zapatillas').remove([fotoUrl]);
                            if (deleteFotoError) {
                                console.warn("Advertencia: No se pudo eliminar la foto del storage.", deleteFotoError);
                                // No lanzar error crítico si la foto no se pudo eliminar, el producto ya está fuera de la DB
                            }
                        }
                        
                        alert('¡Producto eliminado con éxito!');
                        mostrarInventario(); // Recargar el inventario
                    } catch (error) {
                        alert(`Error al eliminar producto: ${error.message}`);
                        console.error('Error:', error);
                        boton.textContent = 'Eliminar Producto';
                        boton.disabled = false;
                    }
                }
            }

            // Manejar botón de Editar Producto (abre el modal)
            if (e.target.classList.contains('edit-btn')) {
                const modeloId = e.target.dataset.modeloId;
                abrirModalEdicion(modeloId);
            }
        });


        // --- Funciones del Modal de Edición ---

        // Función para abrir el modal de edición y cargar datos
        async function abrirModalEdicion(modeloId) {
            // Consultar los datos del modelo específico
            const { data: modelo, error } = await supabaseClient
                .from('modelos')
                .select(`id, nombre, foto_url, marca_id, marcas ( nombre )`) // CAMBIO: Precio eliminado
                .eq('id', modeloId)
                .single(); // Usa .single() para un solo registro

            if (error || !modelo) {
                alert('Error al cargar los datos del producto para edición.');
                console.error('Error al cargar modelo para edición:', error);
                return;
            }

            // Rellenar el formulario del modal con los datos del modelo
            editProductIdInput.value = modelo.id;
            editCurrentFotoUrlInput.value = modelo.foto_url;
            editNombreInput.value = modelo.nombre;
            // editPrecioInput.value = modelo.precio; // CAMBIO: Precio eliminado

            // Cargar marcas en el selector del modal y seleccionar la marca actual
            await cargarMarcasEnSelectores(); // Asegurarse de que las marcas están cargadas
            editMarcaSelect.value = modelo.marca_id;

            // Mostrar la imagen actual
            const imageUrl = SUPABASE_URL + '/storage/v1/object/public/fotos-zapatillas/' + modelo.foto_url;
            editCurrentFoto.src = imageUrl;

            editProductModal.style.display = 'flex'; // Muestra el modal (flex para centrar)
        }

        // Cierra el modal de edición
        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                editProductModal.style.display = 'none';
                editProductForm.reset(); // Limpia el formulario al cerrar
            });
        });

        // Cierra el modal si se hace clic fuera del contenido
        window.addEventListener('click', function(event) {
            if (event.target == editProductModal) {
                editProductModal.style.display = 'none';
                editProductForm.reset(); // Limpia el formulario al cerrar
            }
        });

        // Evento para guardar los cambios del producto desde el modal
        editProductForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const boton = e.target.querySelector('button[type="submit"]');
            boton.textContent = 'Guardando...';
            boton.disabled = true;

            const modeloId = editProductIdInput.value;
            const nuevoNombre = editNombreInput.value;
            // const nuevoPrecio = parseFloat(editPrecioInput.value); // CAMBIO: Precio eliminado
            const nuevaMarcaId = editMarcaSelect.value;
            const nuevaFotoFile = editFotoInput.files[0];
            let nuevaFotoUrl = editCurrentFotoUrlInput.value; // Por defecto, mantiene la foto actual

            try {
                if (!nuevoNombre || !nuevaMarcaId) { // CAMBIO: Validacion sin precio
                    throw new Error("Por favor, completa todos los campos (nombre y marca).");
                }
                
                // Si hay una nueva foto, subirla y actualizar la URL
                if (nuevaFotoFile) {
                    const cleanFileName = nuevaFotoFile.name.replace(/\s+/g, '-').replace(/[^\w.-]/g, '');
                    const fileName = `${Date.now()}-${cleanFileName}`;
                    const { error: uploadError } = await supabaseClient.storage.from('fotos-zapatillas').upload(fileName, nuevaFotoFile);
                    if (uploadError) throw uploadError;
                    
                    // Eliminar la foto antigua si existe y es diferente a la nueva
                    if (editCurrentFotoUrlInput.value && editCurrentFotoUrlInput.value !== fileName) {
                        const { error: deleteOldFotoError } = await supabaseClient.storage.from('fotos-zapatillas').remove([editCurrentFotoUrlInput.value]);
                        if (deleteOldFotoError) {
                            console.warn("Advertencia: No se pudo eliminar la foto antigua del storage.", deleteOldFotoError);
                        }
                    }
                    nuevaFotoUrl = fileName;
                }

                // Actualizar el modelo en la tabla 'modelos'
                const { error: updateModeloError } = await supabaseClient
                    .from('modelos')
                    .update({
                        nombre: nuevoNombre,
                        // precio: nuevoPrecio, // CAMBIO: Precio eliminado
                        marca_id: nuevaMarcaId,
                        foto_url: nuevaFotoUrl
                    })
                    .eq('id', modeloId);

                if (updateModeloError) throw updateModeloError;

                alert('¡Producto actualizado con éxito!');
                editProductModal.style.display = 'none'; // Cierra el modal
                editProductForm.reset(); // Limpia el formulario
                mostrarInventario(); // Recarga el inventario para ver los cambios
                
            } catch (error) {
                alert(`Error al actualizar el producto: ${error.message}`);
                console.error('Error:', error);
            } finally {
                boton.textContent = 'Guardar Cambios';
                boton.disabled = false;
            }
        });

        // --- Inicio al cargar la página ---
        document.addEventListener('DOMContentLoaded', async function() {
            // Verifica la sesión al cargar la página
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                // Si hay sesión activa, muestra el contenido protegido
                loginContainer.style.display = 'none';
                contenidoProtegido.style.display = 'block';
                // Carga los datos
                mostrarInventario();
                cargarMarcasEnSelectores();
                renderTallesAgregados();
            } else {
                // Si no hay sesión, muestra el formulario de login
                loginContainer.style.display = 'block';
                contenidoProtegido.style.display = 'none';
            }
        });

    </script>
</body>
</html>
